<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad++ Web - Advanced Text Editor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        /* Custom CSS for specific editor elements that Tailwind doesn't easily cover */
        body {
            font-family: 'Inter', 'Consolas', 'Monaco', 'Courier New', monospace; /* Using Inter font */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .editor-container {
            position: relative;
            display: flex; /* Use flex to align line numbers and editor */
            flex: 1;
            overflow: hidden;
        }

        .line-numbers {
            width: 40px; /* Fixed width for line numbers */
            background: #1a202c;
            color: #a0aec0;
            padding: 16px 8px 16px 0;
            text-align: right;
            font-size: 14px;
            line-height: 1.5;
            overflow: hidden; /* Hide scrollbar for line numbers */
            user-select: none; /* Prevent selection of line numbers */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .line-numbers div {
            height: 21px; /* Approximate line height for sync */
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .editor, .highlighted-content {
            width: 100%;
            height: 100%;
            background: #1a202c;
            color: #e2e8f0;
            border: none;
            outline: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 16px;
            resize: none;
            tab-size: 4;
            white-space: pre-wrap; /* Default word wrap */
            overflow-y: auto; /* Enable scrolling */
            position: absolute; /* Position both editor and highlighted content */
            top: 0;
            left: 0;
        }

        .editor {
            z-index: 20; /* Editor on top */
            caret-color: #e2e8f0; /* Ensure caret is visible */
            color: transparent; /* Hide text in editor to show highlighted content */
        }

        .highlighted-content {
            z-index: 10; /* Highlighted content below editor */
            pointer-events: none; /* Allow clicks to pass through to editor */
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a202c;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: #2d3748;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            min-width: 300px;
            max-width: 90%;
            color: #e2e8f0;
            position: relative;
        }

        .modal-content h3 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: #cbd5e0;
        }

        .modal-content input[type="text"],
        .modal-content input[type="password"] {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 16px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: #e2e8f0;
        }

        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-content .modal-buttons button {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .modal-content .modal-buttons .btn-primary {
            background: #3182ce;
            color: white;
        }

        .modal-content .modal-buttons .btn-primary:hover {
            background: #2c5282;
        }

        .modal-content .modal-buttons .btn-secondary {
            background: #4a5568;
            color: #e2e8f0;
        }

        .modal-content .modal-buttons .btn-secondary:hover {
            background: #718096;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            min-width: 150px;
            padding: 8px 0;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #e2e8f0;
        }

        .context-menu-item:hover {
            background: #4a5568;
        }

        .context-menu-separator {
            height: 1px;
            background: #4a5568;
            margin: 8px 0;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 h-screen overflow-hidden flex flex-col">
    <div class="container flex flex-col h-screen">
        <!-- Menu Bar -->
        <div class="menu-bar bg-gray-900 p-2 border-b border-gray-700 flex items-center gap-5 rounded-b-md">
            <div class="relative inline-block group">
                <span class="menu-item cursor-pointer px-3 py-1 rounded-md transition-colors hover:bg-gray-700">File</span>
                <div class="absolute hidden group-hover:block bg-gray-800 min-w-[180px] shadow-lg z-50 border border-gray-700 rounded-md top-full left-0">
                    <a href="#" onclick="createNewFile()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">New (Ctrl+N)</a>
                    <a href="#" onclick="openFile()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Open (Ctrl+O)</a>
                    <a href="#" onclick="saveFile()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Save (Ctrl+S)</a>
                    <a href="#" onclick="saveFileAs()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Save As (Ctrl+Shift+S)</a>
                    <a href="#" onclick="exportFile()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Export</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <a href="#" onclick="saveAllToCloud()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Save All to Cloud</a>
                    <a href="#" onclick="loadFilesFromCloud()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Load Files from Cloud</a>
                </div>
            </div>
            <div class="relative inline-block group">
                <span class="menu-item cursor-pointer px-3 py-1 rounded-md transition-colors hover:bg-gray-700">Edit</span>
                <div class="absolute hidden group-hover:block bg-gray-800 min-w-[180px] shadow-lg z-50 border border-gray-700 rounded-md top-full left-0">
                    <a href="#" onclick="undo()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Undo (Ctrl+Z)</a>
                    <a href="#" onclick="redo()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Redo (Ctrl+Y)</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <a href="#" onclick="showFindDialog()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Find (Ctrl+F)</a>
                    <a href="#" onclick="showReplaceDialog()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Replace (Ctrl+H)</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <a href="#" onclick="selectAll()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Select All (Ctrl+A)</a>
                    <a href="#" onclick="duplicateLine()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Duplicate Line (Ctrl+Shift+D)</a>
                    <a href="#" onclick="deleteLine()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Delete Line (Ctrl+Shift+L)</a>
                </div>
            </div>
            <div class="relative inline-block group">
                <span class="menu-item cursor-pointer px-3 py-1 rounded-md transition-colors hover:bg-gray-700">View</span>
                <div class="absolute hidden group-hover:block bg-gray-800 min-w-[180px] shadow-lg z-50 border border-gray-700 rounded-md top-full left-0">
                    <a href="#" onclick="toggleFileExplorer()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Toggle File Explorer</a>
                    <a href="#" onclick="toggleWordWrap()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Word Wrap</a>
                    <a href="#" onclick="toggleLineNumbers()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Toggle Line Numbers</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <a href="#" onclick="zoomIn()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Zoom In (Ctrl++)</a>
                    <a href="#" onclick="zoomOut()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Zoom Out (Ctrl+-)</a>
                </div>
            </div>
            <div class="relative inline-block group">
                <span class="menu-item cursor-pointer px-3 py-1 rounded-md transition-colors hover:bg-gray-700">Language</span>
                <div class="absolute hidden group-hover:block bg-gray-800 min-w-[180px] shadow-lg z-50 border border-gray-700 rounded-md top-full left-0">
                    <a href="#" onclick="setLanguage('text')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Plain Text</a>
                    <a href="#" onclick="setLanguage('javascript')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">JavaScript</a>
                    <a href="#" onclick="setLanguage('html')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">HTML</a>
                    <a href="#" onclick="setLanguage('css')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">CSS</a>
                    <a href="#" onclick="setLanguage('python')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Python</a>
                    <a href="#" onclick="setLanguage('json')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">JSON</a>
                    <a href="#" onclick="setLanguage('markdown')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Markdown</a>
                </div>
            </div>
            <div class="relative inline-block group">
                <span class="menu-item cursor-pointer px-3 py-1 rounded-md transition-colors hover:bg-gray-700">Tools</span>
                <div class="absolute hidden group-hover:block bg-gray-800 min-w-[180px] shadow-lg z-50 border border-gray-700 rounded-md top-full left-0">
                    <a href="#" onclick="transformText('uppercase')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Uppercase (Ctrl+Shift+U)</a>
                    <a href="#" onclick="transformText('lowercase')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Lowercase</a>
                    <a href="#" onclick="transformText('capitalize')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Capitalize Words</a>
                    <a href="#" onclick="transformText('reverse')" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Reverse Text</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <a href="#" onclick="sortLines(true)" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Sort Lines (Asc)</a>
                    <a href="#" onclick="sortLines(false)" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Sort Lines (Desc)</a>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <a href="#" onclick="getTextStatistics()" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md">Text Statistics (Ctrl+Shift+Alt+I)</a>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar bg-gray-800 p-2 border-b border-gray-700 flex items-center gap-2 flex-wrap rounded-b-md">
            <button onclick="createNewFile()" title="New File" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üìÑ New</button>
            <button onclick="openFile()" title="Open File" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üìÅ Open</button>
            <button onclick="saveFile()" title="Save File" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üíæ Save</button>
            <button onclick="saveFileAs()" title="Save As" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üíæ Save As</button>
            <span class="text-gray-600">|</span>
            <button onclick="undo()" title="Undo" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">‚Ü∂ Undo</button>
            <button onclick="redo()" title="Redo" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">‚Ü∑ Redo</button>
            <span class="text-gray-600">|</span>
            <button onclick="showFindDialog()" title="Find" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üîç Find</button>
            <button onclick="showReplaceDialog()" title="Replace" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üîÑ Replace</button>
            <span class="text-gray-600">|</span>
            <select id="languageSelect" onchange="changeLanguage()" title="Language" class="bg-gray-700 text-gray-200 border border-gray-600 px-2 py-1 rounded-md text-sm">
                <option value="text">Plain Text</option>
                <option value="javascript">JavaScript</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="python">Python</option>
                <option value="json">JSON</option>
                <option value="markdown">Markdown</option>
            </select>
            <span class="text-gray-600">|</span>
            <label class="text-gray-300 text-sm">Font Size:</label>
            <input type="number" id="fontSize" value="14" min="8" max="32" onchange="changeFontSize()" class="bg-gray-700 text-gray-200 border border-gray-600 px-2 py-1 rounded-md w-16 text-sm">
            <button onclick="zoomIn()" title="Zoom In" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üîç+</button>
            <button onclick="zoomOut()" title="Zoom Out" class="bg-gray-700 text-gray-200 border-none px-3 py-1 rounded-md cursor-pointer text-sm transition-colors hover:bg-gray-600">üîç-</button>
        </div>

        <!-- Main Content -->
        <div class="main-content flex flex-1 overflow-hidden">
            <!-- File Explorer -->
            <div class="file-explorer w-64 bg-gray-900 border-r border-gray-700 flex flex-col transition-all duration-300 ease-in-out" id="fileExplorer">
                <div class="explorer-header p-3 bg-gray-800 border-b border-gray-700 font-bold text-sm text-gray-200">
                    Files
                </div>
                <div class="file-list flex-1 overflow-y-auto p-2" id="fileList">
                    <!-- Files will be populated here -->
                </div>
            </div>

            <!-- Editor Area -->
            <div class="editor-area flex-1 flex flex-col">
                <div class="tabs flex bg-gray-800 border-b border-gray-700 overflow-x-auto" id="tabs">
                    <!-- Tabs will be populated here -->
                </div>
                <div class="editor-container flex-1 relative">
                    <div class="line-numbers" id="lineNumbers"></div>
                    <div class="editor-wrapper">
                        <textarea class="editor" id="editor" placeholder="Start typing your text here..." spellcheck="false"></textarea>
                        <pre class="highlighted-content language-text" id="highlightedContent"><code class="language-text"></code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar bg-gray-900 p-1.5 border-t border-gray-700 flex justify-between items-center text-xs text-gray-400 rounded-t-md">
            <div class="status-left flex gap-4">
                <span id="fileStatus">Untitled</span>
                <span id="languageStatus">Plain Text</span>
                <span id="userIdStatus">User ID: N/A</span>
            </div>
            <div class="status-right flex gap-4">
                <span id="cursorPosition">Line 1, Column 1</span>
                <span id="characterCount">0 characters</span>
                <span id="wordCount">0 words</span>
            </div>
        </div>

        <!-- Find/Replace Dialog -->
        <div class="find-dialog hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-xl z-40 min-w-[350px]" id="findDialog">
            <button class="find-close absolute top-2 right-2 bg-transparent border-none text-gray-400 cursor-pointer text-xl hover:text-white" onclick="closeFindDialog()">√ó</button>
            <h3 class="text-lg font-semibold mb-4 text-gray-200" id="dialogTitle">Find</h3>
            <div class="mb-2">
                <label class="block text-gray-400 text-sm mb-1">Find:</label>
                <input type="text" id="findInput" placeholder="Enter text to find" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-gray-200 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>
            <div class="mb-4" id="replaceGroup">
                <label class="block text-gray-400 text-sm mb-1">Replace with:</label>
                <input type="text" id="replaceInput" placeholder="Enter replacement text" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-gray-200 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>
            <div class="flex items-center mb-4">
                <input type="checkbox" id="caseSensitive" class="mr-2 rounded text-blue-500 focus:ring-blue-500">
                <label for="caseSensitive" class="text-gray-300 text-sm">Case sensitive</label>
            </div>
            <div class="find-buttons flex gap-2 justify-end">
                <button onclick="findNext()" class="px-4 py-2 bg-blue-600 text-white rounded-md cursor-pointer text-sm hover:bg-blue-700 transition-colors">Find Next</button>
                <button onclick="findPrevious()" class="px-4 py-2 bg-blue-600 text-white rounded-md cursor-pointer text-sm hover:bg-blue-700 transition-colors">Find Previous</button>
                <button id="replaceBtn" onclick="replaceText()" class="px-4 py-2 bg-green-600 text-white rounded-md cursor-pointer text-sm hover:bg-green-700 transition-colors">Replace</button>
                <button id="replaceAllBtn" onclick="replaceAll()" class="px-4 py-2 bg-red-600 text-white rounded-md cursor-pointer text-sm hover:bg-red-700 transition-colors">Replace All</button>
            </div>
        </div>

        <!-- Custom Modal Placeholder -->
        <div id="customModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 id="modalTitle"></h3>
                <p id="modalMessage" class="text-gray-300 mb-4"></p>
                <input type="text" id="modalInput" class="hidden" placeholder="Enter value">
                <div class="modal-buttons">
                    <button id="modalConfirmBtn" class="btn-primary hidden">OK</button>
                    <button id="modalCancelBtn" class="btn-secondary hidden">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Hidden file input -->
        <input type="file" id="fileInput" class="hidden" accept=".txt,.js,.html,.css,.json,.md,.py,.xml,.csv">
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Initialize Firebase and authenticate
        async function initFirebase() {
            try {
                // Check if __firebase_config is defined, otherwise use a placeholder
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "YOUR_API_KEY",
                    authDomain: "YOUR_AUTH_DOMAIN",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_STORAGE_BUCKET",
                    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                    appId: "YOUR_APP_ID"
                };

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdStatus').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        // Load files from cloud after authentication
                        await loadFilesFromCloud();
                    } else {
                        // Sign in anonymously if no user is logged in
                        console.log("No user signed in. Attempting anonymous sign-in...");
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        // userId will be set by the onAuthStateChanged listener after signIn
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                showModal('Error', `Failed to initialize Firebase: ${error.message}`);
            }
        }

        // Save all open files to Firestore
        window.saveAllToCloud = async function() {
            if (!isAuthReady || !userId) {
                showModal('Authentication Required', 'Please wait for authentication to complete before saving to cloud.');
                return;
            }

            if (files.length === 0) {
                showModal('No Files', 'There are no files to save.');
                return;
            }

            try {
                // Store metadata about open files
                const openFilesMetadata = files.map(file => ({
                    id: file.id,
                    name: file.name,
                    language: file.language,
                    modified: file.modified,
                    cursorPosition: file.cursorPosition
                }));
                const userDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/metadata/open_files`);
                await setDoc(userDocRef, { files: openFilesMetadata });

                // Store content of each file
                for (const file of files) {
                    const fileDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/files`, file.id);
                    await setDoc(fileDocRef, {
                        name: file.name,
                        content: file.content,
                        language: file.language,
                        lastModified: new Date().toISOString()
                    });
                    file.modified = false; // Mark as saved
                }
                updateTabs();
                updateStatusBar();
                showModal('Success', 'All files saved to cloud successfully!');
            } catch (error) {
                console.error("Error saving files to Firestore:", error);
                showModal('Error', `Failed to save files to cloud: ${error.message}`);
            }
        };

        // Load files from Firestore
        window.loadFilesFromCloud = async function() {
            if (!isAuthReady || !userId) {
                // If auth is not ready, the onAuthStateChanged listener will call this once ready.
                return;
            }

            try {
                const userDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/metadata/open_files`);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const metadata = docSnap.data().files;
                    const loadedFiles = [];

                    for (const meta of metadata) {
                        const fileDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/files`, meta.id);
                        const fileSnap = await getDoc(fileDocRef);
                        if (fileSnap.exists()) {
                            const fileData = fileSnap.data();
                            const loadedFile = new FileTab(fileData.name, fileData.content, fileData.language);
                            loadedFile.id = meta.id;
                            loadedFile.modified = meta.modified;
                            loadedFile.cursorPosition = meta.cursorPosition;
                            loadedFiles.push(loadedFile);
                        } else {
                            console.warn(`File content for ${meta.name} (ID: ${meta.id}) not found.`);
                        }
                    }

                    if (loadedFiles.length > 0) {
                        files = loadedFiles;
                        currentFileIndex = 0; // Default to first loaded file
                        updateTabs();
                        updateFileList();
                        switchToFile(currentFileIndex);
                        showModal('Success', 'Files loaded from cloud successfully!');
                    } else {
                        showModal('Info', 'No files found in cloud storage. Starting with a new file.');
                        createNewFile();
                    }
                } else {
                    showModal('Info', 'No saved files found in cloud storage. Starting with a new file.');
                    createNewFile();
                }
            } catch (error) {
                console.error("Error loading files from Firestore:", error);
                showModal('Error', `Failed to load files from cloud: ${error.message}`);
                createNewFile(); // Ensure editor is usable even if load fails
            }
        };

        // Call initFirebase on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
    <!-- Prism.js components for various languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Ensure Prism autoloader is configured to load languages on demand
        Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';

        // Global variables
        let files = [];
        let currentFileIndex = 0;
        let findIndex = -1;
        let findMatches = []; // Stores indices of all matches
        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY_SIZE = 100; // Limit undo/redo history

        // File structure
        class FileTab {
            constructor(name, content = '', language = 'text', id = crypto.randomUUID()) {
                this.id = id; // Unique ID for Firestore
                this.name = name;
                this.content = content;
                this.language = language;
                this.modified = false;
                this.cursorPosition = 0;
                this.scrollPosition = { top: 0, left: 0 };
            }
        }

        // --- Core Application Logic ---

        // Initialize the application
        function init() {
            createNewFile();
            setupEventListeners();
            updateStatusBar();
            // Local storage is now secondary to Firestore for persistence
            // loadFromLocalStorage(); // Commented out as Firestore is primary
            startAutoSave();
            addAdvancedMenuItems();
        }

        // Setup event listeners
        function setupEventListeners() {
            const editor = document.getElementById('editor');
            const fileInput = document.getElementById('fileInput');
            const highlightedContent = document.getElementById('highlightedContent');

            // Editor events
            editor.addEventListener('input', handleEditorChange);
            editor.addEventListener('keydown', handleKeyDown);
            editor.addEventListener('click', updateCursorPosition);
            editor.addEventListener('keyup', updateCursorPosition);
            editor.addEventListener('scroll', syncScroll); // Sync scroll for line numbers and highlighter

            // Sync scroll from highlighted content (read-only, but for completeness)
            highlightedContent.addEventListener('scroll', syncScroll);

            // File input event
            fileInput.addEventListener('change', handleFileLoad);

            // Window events
            window.addEventListener('beforeunload', handleBeforeUnload);
            window.addEventListener('resize', handleResize);

            // Global keyboard shortcuts
            document.addEventListener('keydown', handleGlobalKeyDown);

            // Drag and drop for file input
            const editorArea = document.querySelector('.editor-area');
            editorArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editorArea.classList.add('border-blue-500', 'border-2'); // Visual feedback
            });
            editorArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editorArea.classList.remove('border-blue-500', 'border-2');
            });
            editorArea.addEventListener('drop', handleFileDrop);

            // Context menu listeners
            document.addEventListener('contextmenu', handleContextMenu);
        }

        // Sync editor and highlighted content scroll
        function syncScroll(e) {
            const editor = document.getElementById('editor');
            const highlightedContent = document.getElementById('highlightedContent');
            const lineNumbers = document.getElementById('lineNumbers');

            // Determine which element triggered the scroll
            const target = e.target;

            if (target === editor) {
                highlightedContent.scrollTop = editor.scrollTop;
                highlightedContent.scrollLeft = editor.scrollLeft;
                lineNumbers.scrollTop = editor.scrollTop;
            } else if (target === highlightedContent) {
                editor.scrollTop = highlightedContent.scrollTop;
                editor.scrollLeft = highlightedContent.scrollLeft;
                lineNumbers.scrollTop = highlightedContent.scrollTop;
            } else if (target === lineNumbers) {
                editor.scrollTop = lineNumbers.scrollTop;
                highlightedContent.scrollTop = lineNumbers.scrollTop;
            }

            // Save scroll position for current file
            if (files[currentFileIndex]) {
                files[currentFileIndex].scrollPosition = {
                    top: editor.scrollTop,
                    left: editor.scrollLeft
                };
            }
        }

        // Handle global keyboard shortcuts
        function handleGlobalKeyDown(e) {
            if (e.ctrlKey || e.metaKey) { // Ctrl for Windows/Linux, Cmd for Mac
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        createNewFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFile();
                        break;
                    case 's':
                        e.preventDefault();
                        if (e.shiftKey) {
                            saveFileAs();
                        } else {
                            saveFile();
                        }
                        break;
                    case 'f':
                        e.preventDefault();
                        showFindDialog();
                        break;
                    case 'h':
                        e.preventDefault();
                        showReplaceDialog();
                        break;
                    case 'z':
                        e.preventDefault();
                        undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 'a':
                        e.preventDefault();
                        selectAll();
                        break;
                    case '=': // Ctrl+=
                    case '+': // Ctrl++
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-': // Ctrl+-
                        e.preventDefault();
                        zoomOut();
                        break;
                    case 'd': // Ctrl+Shift+D for Duplicate Line
                        if (e.shiftKey) {
                            e.preventDefault();
                            duplicateLine();
                        }
                        break;
                    case 'l': // Ctrl+Shift+L for Delete Line
                        if (e.shiftKey) {
                            e.preventDefault();
                            deleteLine();
                        }
                        break;
                    case 'u': // Ctrl+Shift+U for Uppercase
                        if (e.shiftKey) {
                            e.preventDefault();
                            transformText('uppercase');
                        }
                        break;
                    case 'i': // Ctrl+Shift+Alt+I for Text Statistics
                        if (e.shiftKey && e.altKey) {
                            e.preventDefault();
                            getTextStatistics();
                        }
                        break;
                }
            }
        }

        // Handle editor changes
        function handleEditorChange() {
            const editor = document.getElementById('editor');
            if (files[currentFileIndex]) {
                const oldContent = files[currentFileIndex].content;
                const newContent = editor.value;

                // Only push to undo stack if content actually changed
                if (oldContent !== newContent) {
                    pushToUndoStack(oldContent, editor.selectionStart);
                    redoStack = []; // Clear redo stack on new change
                    files[currentFileIndex].content = newContent;
                    files[currentFileIndex].modified = true;
                    updateTabs();
                    updateStatusBar();
                    highlightCode(); // Re-highlight on change
                    saveToLocalStorage(); // Auto-save local state
                }
            }
        }

        // Handle special key combinations in editor
        function handleKeyDown(e) {
            const editor = e.target;
            const start = editor.selectionStart;
            const end = editor.selectionEnd;

            // Tab handling
            if (e.key === 'Tab') {
                e.preventDefault();
                const tabSize = parseInt(document.getElementById('fontSize').value) / 4; // Use font size to approximate tab width
                const indent = ' '.repeat(4); // Use 4 spaces for indentation

                const selectedText = editor.value.substring(start, end);
                const beforeSelection = editor.value.substring(0, start);
                const afterSelection = editor.value.substring(end);

                if (e.shiftKey) {
                    // Shift+Tab: Remove indentation
                    const lines = selectedText.split('\n');
                    const unindentedLines = lines.map(line => {
                        if (line.startsWith(indent)) {
                            return line.substring(indent.length);
                        } else if (line.startsWith('\t')) {
                            return line.substring(1);
                        }
                        return line;
                    });
                    const newText = unindentedLines.join('\n');
                    editor.value = beforeSelection + newText + afterSelection;
                    editor.selectionStart = start;
                    editor.selectionEnd = start + newText.length;
                } else {
                    // Tab: Add indentation
                    if (selectedText.includes('\n')) {
                        // Multiple lines selected
                        const lines = selectedText.split('\n');
                        const indentedLines = lines.map(line => indent + line);
                        const newText = indentedLines.join('\n');
                        editor.value = beforeSelection + newText + afterSelection;
                        editor.selectionStart = start;
                        editor.selectionEnd = start + newText.length;
                    } else {
                        // Single line or no selection
                        editor.value = beforeSelection + indent + afterSelection;
                        editor.selectionStart = editor.selectionEnd = start + indent.length;
                    }
                }
                handleEditorChange();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const currentLineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
                const currentLine = editor.value.substring(currentLineStart, start);
                const indentationMatch = currentLine.match(/^\s*/);
                const indentation = indentationMatch ? indentationMatch[0] : '';

                let newContent = editor.value.substring(0, start) + '\n' + indentation + editor.value.substring(end);
                editor.value = newContent;
                editor.selectionStart = editor.selectionEnd = start + 1 + indentation.length;
                handleEditorChange();
            } else if (e.key === '(' || e.key === '[' || e.key === '{') {
                // Auto-close brackets
                const closingBracket = { '(': ')', '[': ']', '{': '}' }[e.key];
                const before = editor.value.substring(0, start);
                const after = editor.value.substring(end);
                editor.value = before + e.key + closingBracket + after;
                editor.selectionStart = editor.selectionEnd = start + 1;
                handleEditorChange();
            }
        }

        // Update cursor position and status
        function updateCursorPosition() {
            const editor = document.getElementById('editor');
            const cursorPos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            const lines = textBeforeCursor.split('\n');
            const currentLine = lines.length;
            const currentColumn = lines[lines.length - 1].length + 1;

            document.getElementById('cursorPosition').textContent = `Line ${currentLine}, Column ${currentColumn}`;

            // Save cursor position for current file
            if (files[currentFileIndex]) {
                files[currentFileIndex].cursorPosition = cursorPos;
            }
        }

        // Update status bar
        function updateStatusBar() {
            const editor = document.getElementById('editor');
            const content = editor.value;
            const characterCount = content.length;
            const wordCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;

            document.getElementById('characterCount').textContent = `${characterCount} characters`;
            document.getElementById('wordCount').textContent = `${wordCount} words`;

            if (files[currentFileIndex]) {
                const fileName = files[currentFileIndex].name;
                const modified = files[currentFileIndex].modified ? ' ‚Ä¢' : '';
                document.getElementById('fileStatus').textContent = fileName + modified;
                document.getElementById('languageStatus').textContent = files[currentFileIndex].language;
            }

            updateCursorPosition();
            updateLineNumbers(); // Update line numbers whenever content or scroll changes
        }

        // --- File Management ---

        // Create new file
        function createNewFile() {
            if (files.length > 0 && files[currentFileIndex].modified) {
                showConfirmModal('Unsaved Changes', `File "${files[currentFileIndex].name}" has unsaved changes. Do you want to create a new file anyway?`)
                    .then(confirmed => {
                        if (confirmed) {
                            _createNewFileInternal();
                        }
                    });
            } else {
                _createNewFileInternal();
            }
        }

        function _createNewFileInternal() {
            const fileName = `Untitled-${files.length + 1}.txt`;
            const newFile = new FileTab(fileName);
            files.push(newFile);
            currentFileIndex = files.length - 1;

            updateTabs();
            updateFileList();
            switchToFile(currentFileIndex);
            saveToLocalStorage();
        }

        // Open file
        function openFile() {
            document.getElementById('fileInput').click();
        }

        // Handle file loading from local system
        function handleFileLoad(e) {
            const fileList = e.target.files;

            if (fileList.length === 0) return;

            // Handle potential unsaved changes in current file before loading new ones
            if (files.length > 0 && files[currentFileIndex].modified) {
                showConfirmModal('Unsaved Changes', `File "${files[currentFileIndex].name}" has unsaved changes. Continue opening new files?`)
                    .then(confirmed => {
                        if (!confirmed) {
                            e.target.value = ''; // Clear input
                            return;
                        }
                        _processFiles(fileList);
                    });
            } else {
                _processFiles(fileList);
            }

            // Clear the input to allow opening the same file again
            e.target.value = '';
        }

        // Helper to process files after confirmation
        function _processFiles(fileList) {
            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                const reader = new FileReader();

                reader.onload = function(event) {
                    const content = event.target.result;
                    const language = getLanguageFromExtension(file.name);
                    const newFile = new FileTab(file.name, content, language);

                    // Check if file with same name already exists and replace it
                    const existingIndex = files.findIndex(f => f.name === newFile.name);
                    if (existingIndex !== -1) {
                        files[existingIndex] = newFile;
                        currentFileIndex = existingIndex;
                        showModal('File Replaced', `File "${newFile.name}" was replaced with the newly opened version.`);
                    } else {
                        files.push(newFile);
                        currentFileIndex = files.length - 1;
                    }

                    updateTabs();
                    updateFileList();
                    switchToFile(currentFileIndex);
                    saveToLocalStorage();
                };

                reader.readAsText(file);
            }
        }

        // Handle file drop for local system
        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('border-blue-500', 'border-2'); // Remove visual feedback

            const fileList = e.dataTransfer.files;
            if (fileList.length > 0) {
                handleFileLoad({ target: { files: fileList } });
            }
        }

        // Get language from file extension
        function getLanguageFromExtension(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const languageMap = {
                'js': 'javascript',
                'html': 'html',
                'css': 'css',
                'py': 'python',
                'json': 'json',
                'md': 'markdown',
                'xml': 'xml',
                'txt': 'text',
                'ts': 'typescript',
                'jsx': 'jsx',
                'tsx': 'tsx',
                'java': 'java',
                'c': 'c',
                'cpp': 'cpp',
                'cs': 'csharp',
                'php': 'php',
                'rb': 'ruby',
                'go': 'go',
                'swift': 'swift',
                'sql': 'sql',
            };
            return languageMap[ext] || 'text';
        }

        // Save current file to local system
        function saveFile() {
            if (files.length === 0) {
                showModal('No File', 'No file is open to save.');
                return;
            }

            const currentFile = files[currentFileIndex];
            const blob = new Blob([currentFile.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            currentFile.modified = false;
            updateTabs();
            updateStatusBar();
            showModal('Saved', `File "${currentFile.name}" saved successfully!`);
            saveToLocalStorage(); // Update local storage after explicit save
        }

        // Save file as to local system
        function saveFileAs() {
            if (files.length === 0) {
                showModal('No File', 'No file is open to save.');
                return;
            }

            showPromptModal('Save File As', 'Enter filename:', files[currentFileIndex].name)
                .then(newName => {
                    if (newName) {
                        files[currentFileIndex].name = newName;
                        files[currentFileIndex].language = getLanguageFromExtension(newName);
                        saveFile(); // Call saveFile which will now use the new name
                        updateTabs();
                        updateFileList();
                        updateStatusBar();
                    }
                });
        }

        // Export file (with more format options)
        function exportFile() {
            if (files.length === 0) {
                showModal('No File', 'No file is open to export.');
                return;
            }

            const currentFile = files[currentFileIndex];
            const formats = {
                'Text (.txt)': 'text/plain',
                'HTML (.html)': 'text/html',
                'JSON (.json)': 'application/json',
                'Markdown (.md)': 'text/markdown',
                'JavaScript (.js)': 'application/javascript',
                'CSS (.css)': 'text/css',
                'Python (.py)': 'text/x-python'
            };

            const formatOptions = Object.keys(formats).map((key, index) => `${index + 1}. ${key}`).join('\n');

            showPromptModal('Export File', `Choose format:\n${formatOptions}`, '1')
                .then(selectedOption => {
                    if (selectedOption) {
                        const index = parseInt(selectedOption) - 1;
                        const formatName = Object.keys(formats)[index];
                        if (formatName) {
                            const mimeType = formats[formatName];
                            const blob = new Blob([currentFile.content], { type: mimeType });
                            const url = URL.createObjectURL(blob);

                            const a = document.createElement('a');
                            a.href = url;
                            // Ensure correct extension for download
                            const newExtension = formatName.match(/\.\w+$/)[0];
                            a.download = currentFile.name.split('.')[0] + newExtension;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            showModal('Exported', `File "${currentFile.name}" exported as "${formatName}"`);
                        } else {
                            showModal('Invalid Option', 'Please select a valid format option.');
                        }
                    }
                });
        }

        // Update tabs display
        function updateTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';

            files.forEach((file, index) => {
                const tab = document.createElement('div');
                tab.className = `tab px-5 py-3 bg-gray-900 border-r border-gray-700 cursor-pointer text-sm flex items-center gap-2 min-w-[120px] relative rounded-tr-md ${index === currentFileIndex ? 'active bg-gray-800' : 'hover:bg-gray-700'}`;
                tab.innerHTML = `
                    <span class="file-icon text-base">${getFileIcon(file.language)}</span>
                    <span>${file.name}${file.modified ? ' ‚Ä¢' : ''}</span>
                    <button class="tab-close ml-auto bg-transparent border-none text-gray-400 cursor-pointer p-0.5 rounded-sm text-lg leading-none hover:bg-red-600 hover:text-white" onclick="event.stopPropagation(); closeFile(${index})" title="Close">√ó</button>
                `;
                tab.onclick = () => switchToFile(index);
                tabsContainer.appendChild(tab);
            });
        }

        // Get file icon based on language
        function getFileIcon(language) {
            const icons = {
                'javascript': 'üìú',
                'html': 'üåê',
                'css': 'üé®',
                'python': 'üêç',
                'json': 'üìã',
                'markdown': 'üìù',
                'typescript': 'üìÑ', // Placeholder, could use a different icon
                'jsx': '‚öõÔ∏è', // React icon
                'tsx': '‚öõÔ∏è',
                'java': '‚òï',
                'c': '‚öôÔ∏è',
                'cpp': '‚öôÔ∏è',
                'csharp': 'C#', // Simple text for C#
                'php': 'üêò',
                'ruby': 'üíé',
                'go': 'üêøÔ∏è',
                'swift': 'üê¶',
                'sql': 'üóÑÔ∏è',
                'xml': 'üìÑ',
                'csv': 'üìä',
                'text': 'üìÑ'
            };
            return icons[language] || 'üìÑ';
        }

        // Switch to file
        function switchToFile(index) {
            if (index < 0 || index >= files.length) return;

            // Save current file's state before switching
            if (files[currentFileIndex]) {
                files[currentFileIndex].cursorPosition = document.getElementById('editor').selectionStart;
                files[currentFileIndex].scrollPosition = {
                    top: document.getElementById('editor').scrollTop,
                    left: document.getElementById('editor').scrollLeft
                };
            }

            currentFileIndex = index;
            const editor = document.getElementById('editor');
            const highlightedContent = document.getElementById('highlightedContent');
            const currentFile = files[index];

            editor.value = currentFile.content;
            document.getElementById('languageSelect').value = currentFile.language;
            highlightedContent.className = `highlighted-content language-${currentFile.language}`;

            // Restore cursor and scroll position
            setTimeout(() => {
                editor.selectionStart = editor.selectionEnd = currentFile.cursorPosition;
                editor.scrollTop = currentFile.scrollPosition.top;
                editor.scrollLeft = currentFile.scrollPosition.left;
                highlightedContent.scrollTop = currentFile.scrollPosition.top;
                highlightedContent.scrollLeft = currentFile.scrollPosition.left;
                editor.focus();
            }, 0);

            updateTabs();
            updateFileList();
            updateStatusBar();
            highlightCode(); // Re-highlight for the new file
        }

        // Close file
        function closeFile(index) {
            if (files.length === 0) return;

            const file = files[index];
            if (file.modified) {
                showConfirmModal('Unsaved Changes', `"${file.name}" has unsaved changes. Close anyway?`)
                    .then(confirmed => {
                        if (confirmed) {
                            _closeFileInternal(index);
                        }
                    });
            } else {
                _closeFileInternal(index);
            }
        }

        function _closeFileInternal(index) {
            files.splice(index, 1);

            if (files.length === 0) {
                createNewFile();
            } else {
                if (currentFileIndex >= files.length) {
                    currentFileIndex = files.length - 1;
                }
                switchToFile(currentFileIndex);
            }

            updateTabs();
            updateFileList();
            saveToLocalStorage();
        }

        // Update file list in explorer
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item px-3 py-2 cursor-pointer rounded-md mb-0.5 text-sm flex items-center gap-2 ${index === currentFileIndex ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}`;
                fileItem.innerHTML = `
                    <span class="file-icon text-base">${getFileIcon(file.language)}</span>
                    <span>${file.name}${file.modified ? ' ‚Ä¢' : ''}</span>
                `;
                fileItem.onclick = () => switchToFile(index);
                fileItem.oncontextmenu = (e) => showFileContextMenu(e, index); // Add context menu
                fileList.appendChild(fileItem);
            });
        }

        // --- Editor Operations ---

        // Undo functionality
        function undo() {
            if (undoStack.length > 0) {
                const editor = document.getElementById('editor');
                const { content, cursor } = undoStack.pop();
                redoStack.push({ content: editor.value, cursor: editor.selectionStart }); // Push current state to redo
                editor.value = content;
                editor.selectionStart = editor.selectionEnd = cursor;
                handleEditorChange(); // Trigger update without adding to undo stack
            } else {
                showModal('Undo', 'Nothing to undo.');
            }
        }

        // Redo functionality
        function redo() {
            if (redoStack.length > 0) {
                const editor = document.getElementById('editor');
                const { content, cursor } = redoStack.pop();
                undoStack.push({ content: editor.value, cursor: editor.selectionStart }); // Push current state to undo
                editor.value = content;
                editor.selectionStart = editor.selectionEnd = cursor;
                handleEditorChange(); // Trigger update without adding to undo stack
            } else {
                showModal('Redo', 'Nothing to redo.');
            }
        }

        // Push state to undo stack
        function pushToUndoStack(content, cursor) {
            undoStack.push({ content, cursor });
            if (undoStack.length > MAX_HISTORY_SIZE) {
                undoStack.shift(); // Remove oldest entry
            }
        }

        // Select all text
        function selectAll() {
            const editor = document.getElementById('editor');
            editor.select();
        }

        // Show find dialog
        function showFindDialog() {
            const dialog = document.getElementById('findDialog');
            document.getElementById('replaceGroup').classList.add('hidden');
            document.getElementById('replaceBtn').classList.add('hidden');
            document.getElementById('replaceAllBtn').classList.add('hidden');
            document.getElementById('dialogTitle').textContent = 'Find';
            dialog.classList.remove('hidden');
            document.getElementById('findInput').focus();
        }

        // Show replace dialog
        function showReplaceDialog() {
            const dialog = document.getElementById('findDialog');
            document.getElementById('replaceGroup').classList.remove('hidden');
            document.getElementById('replaceBtn').classList.remove('hidden');
            document.getElementById('replaceAllBtn').classList.remove('hidden');
            document.getElementById('dialogTitle').textContent = 'Find & Replace';
            dialog.classList.remove('hidden');
            document.getElementById('findInput').focus();
        }

        // Close find dialog
        function closeFindDialog() {
            document.getElementById('findDialog').classList.add('hidden');
            clearHighlights();
        }

        // Find next occurrence
        function findNext() {
            const editor = document.getElementById('editor');
            const findText = document.getElementById('findInput').value;
            const caseSensitive = document.getElementById('caseSensitive').checked;
            let content = editor.value;

            if (!caseSensitive) {
                content = content.toLowerCase();
                findText = findText.toLowerCase();
            }

            if (!findText) {
                clearHighlights();
                return;
            }

            let startPos = editor.selectionEnd;
            let foundIndex = content.indexOf(findText, startPos);

            if (foundIndex === -1) {
                // Wrap around to the beginning
                foundIndex = content.indexOf(findText, 0);
            }

            if (foundIndex !== -1) {
                editor.setSelectionRange(foundIndex, foundIndex + findText.length);
                editor.focus();
                highlightMatches(findText, caseSensitive);
            } else {
                showModal('Not Found', 'Text not found.');
                clearHighlights();
            }
        }

        // Find previous occurrence
        function findPrevious() {
            const editor = document.getElementById('editor');
            const findText = document.getElementById('findInput').value;
            const caseSensitive = document.getElementById('caseSensitive').checked;
            let content = editor.value;

            if (!caseSensitive) {
                content = content.toLowerCase();
                findText = findText.toLowerCase();
            }

            if (!findText) {
                clearHighlights();
                return;
            }

            let startPos = editor.selectionStart - 1;
            let foundIndex = content.lastIndexOf(findText, startPos);

            if (foundIndex === -1) {
                // Wrap around to the end
                foundIndex = content.lastIndexOf(findText);
            }

            if (foundIndex !== -1) {
                editor.setSelectionRange(foundIndex, foundIndex + findText.length);
                editor.focus();
                highlightMatches(findText, caseSensitive);
            } else {
                showModal('Not Found', 'Text not found.');
                clearHighlights();
            }
        }

        // Replace current selection
        function replaceText() {
            const editor = document.getElementById('editor');
            const findText = document.getElementById('findInput').value;
            const replaceWith = document.getElementById('replaceInput').value;
            const caseSensitive = document.getElementById('caseSensitive').checked;

            let currentSelection = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            let match = caseSensitive ? currentSelection === findText : currentSelection.toLowerCase() === findText.toLowerCase();

            if (match) {
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = editor.value.substring(0, start) + replaceWith + editor.value.substring(end);
                editor.setSelectionRange(start, start + replaceWith.length);
                handleEditorChange();
                findNext(); // Find the next occurrence after replacement
            } else {
                findNext(); // If current selection isn't a match, find the next one
            }
        }

        // Replace all occurrences
        function replaceAll() {
            const editor = document.getElementById('editor');
            const findText = document.getElementById('findInput').value;
            const replaceWith = document.getElementById('replaceInput').value;
            const caseSensitive = document.getElementById('caseSensitive').checked;

            if (!findText) {
                showModal('Input Required', 'Please enter text to find.');
                return;
            }

            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(findText, flags);
            const originalContent = editor.value;
            const newContent = originalContent.replace(regex, replaceWith);

            if (originalContent !== newContent) {
                editor.value = newContent;
                handleEditorChange();
                const replacements = (originalContent.match(regex) || []).length;
                showModal('Replacement Complete', `Replaced ${replacements} occurrences.`);
            } else {
                showModal('Not Found', 'Text not found for replacement.');
            }
            clearHighlights();
        }

        // Highlight all matches (visual feedback)
        function highlightMatches(searchText, caseSensitive) {
            const editor = document.getElementById('editor');
            const content = editor.value;
            const highlightedContent = document.getElementById('highlightedContent').querySelector('code');

            // Clear previous highlights
            highlightedContent.innerHTML = Prism.highlight(content, Prism.languages[files[currentFileIndex].language], files[currentFileIndex].language);

            if (!searchText) return;

            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(searchText, flags);
            let match;
            let offset = 0;
            let tempContent = content;

            // Simple highlighting for the editor overlay
            // This is a basic approach; a more robust solution would involve modifying the Prism output
            while ((match = regex.exec(tempContent)) !== null) {
                const startIndex = match.index + offset;
                const endIndex = startIndex + match[0].length;

                // Create a span for highlighting
                const span = document.createElement('span');
                span.className = 'bg-yellow-500 bg-opacity-50 rounded'; // Tailwind classes for highlighting
                span.textContent = content.substring(startIndex, endIndex);

                // Replace the matched text in the highlightedContent's innerHTML
                // This is a crude way; a proper solution would rebuild the highlighted HTML
                const originalText = highlightedContent.innerHTML;
                const before = originalText.substring(0, startIndex);
                const after = originalText.substring(endIndex);
                highlightedContent.innerHTML = before + span.outerHTML + after;

                offset += (span.outerHTML.length - match[0].length); // Adjust offset for added HTML
            }
        }

        // Clear highlights
        function clearHighlights() {
            const editor = document.getElementById('editor');
            const highlightedContent = document.getElementById('highlightedContent').querySelector('code');
            highlightedContent.innerHTML = Prism.highlight(editor.value, Prism.languages[files[currentFileIndex].language], files[currentFileIndex].language);
        }

        // Update line numbers
        function updateLineNumbers() {
            const editor = document.getElementById('editor');
            const lineNumbersDiv = document.getElementById('lineNumbers');
            const lineCount = editor.value.split('\n').length;
            let numbersHtml = '';
            for (let i = 1; i <= lineCount; i++) {
                numbersHtml += `<div>${i}</div>`;
            }
            lineNumbersDiv.innerHTML = numbersHtml;
        }

        // Toggle file explorer
        function toggleFileExplorer() {
            const explorer = document.getElementById('fileExplorer');
            explorer.classList.toggle('w-0');
            explorer.classList.toggle('w-64');
            explorer.classList.toggle('border-r'); // Re-add border when visible
        }

        // Toggle word wrap
        function toggleWordWrap() {
            const editor = document.getElementById('editor');
            const highlightedContent = document.getElementById('highlightedContent');
            const isWrapped = editor.style.whiteSpace === 'pre-wrap' || editor.style.whiteSpace === ''; // Default is pre-wrap
            editor.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
            highlightedContent.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
        }

        // Toggle line numbers
        let lineNumbersVisible = true;
        function toggleLineNumbers() {
            const lineNumbersDiv = document.getElementById('lineNumbers');
            lineNumbersVisible = !lineNumbersVisible;
            if (lineNumbersVisible) {
                lineNumbersDiv.style.display = 'block';
                lineNumbersDiv.style.width = '40px';
            } else {
                lineNumbersDiv.style.display = 'none';
                lineNumbersDiv.style.width = '0';
            }
            // Adjust editor-wrapper width if needed (flex handles most of it)
        }

        // Change language
        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            const language = select.value;

            if (files[currentFileIndex]) {
                files[currentFileIndex].language = language;
                document.getElementById('highlightedContent').className = `highlighted-content language-${language}`;
                highlightCode(); // Re-highlight with new language
                updateTabs();
                updateFileList();
                updateStatusBar();
            }
        }

        // Set language from menu
        function setLanguage(language) {
            document.getElementById('languageSelect').value = language;
            changeLanguage();
        }

        // Change font size
        function changeFontSize() {
            const fontSize = document.getElementById('fontSize').value;
            const editor = document.getElementById('editor');
            const highlightedContent = document.getElementById('highlightedContent');
            const lineNumbersDiv = document.getElementById('lineNumbers');

            editor.style.fontSize = fontSize + 'px';
            highlightedContent.style.fontSize = fontSize + 'px';
            lineNumbersDiv.style.fontSize = fontSize + 'px';

            // Adjust line number div height based on new font size (approximate)
            const lineHeight = parseFloat(getComputedStyle(editor).lineHeight);
            const lineDivs = lineNumbersDiv.children;
            for (let i = 0; i < lineDivs.length; i++) {
                lineDivs[i].style.height = `${lineHeight}px`;
            }
            updateLineNumbers(); // Re-render line numbers to adjust heights
        }

        // Zoom in
        function zoomIn() {
            const fontSizeInput = document.getElementById('fontSize');
            const currentSize = parseInt(fontSizeInput.value);
            if (currentSize < 32) {
                fontSizeInput.value = currentSize + 1;
                changeFontSize();
            }
        }

        // Zoom out
        function zoomOut() {
            const fontSizeInput = document.getElementById('fontSize');
            const currentSize = parseInt(fontSizeInput.value);
            if (currentSize > 8) {
                fontSizeInput.value = currentSize - 1;
                changeFontSize();
            }
        }

        // --- Persistence (Local Storage) ---
        // Used for temporary persistence and for initial load before Firestore sync

        // Save to localStorage
        function saveToLocalStorage() {
            try {
                const data = {
                    files: files,
                    currentFileIndex: currentFileIndex
                };
                localStorage.setItem('notepadpp-web-data', JSON.stringify(data));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('notepadpp-web-data');
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.files && parsed.files.length > 0) {
                        files = parsed.files.map(f => {
                            const file = new FileTab(f.name, f.content, f.language, f.id);
                            file.modified = f.modified;
                            file.cursorPosition = f.cursorPosition || 0;
                            file.scrollPosition = f.scrollPosition || { top: 0, left: 0 };
                            return file;
                        });
                        currentFileIndex = parsed.currentFileIndex || 0;

                        updateTabs();
                        updateFileList();
                        switchToFile(currentFileIndex);
                    }
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
        }

        // Auto-save functionality
        function startAutoSave() {
            setInterval(() => {
                saveToLocalStorage();
                // Optionally, also trigger cloud save if authenticated
                // if (window.isAuthReady && window.userId) {
                //     window.saveAllToCloud(); // Consider if auto-saving to cloud is desired frequently
                // }
            }, 30000); // Auto-save every 30 seconds
        }

        // Handle before unload
        function handleBeforeUnload(e) {
            const hasUnsavedChanges = files.some(file => file.modified);
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = ''; // Standard for showing confirmation dialog
                return '';
            }
        }

        // Handle window resize for responsiveness
        function handleResize() {
            const width = window.innerWidth;
            const explorer = document.getElementById('fileExplorer');

            if (width < 768) {
                explorer.classList.add('w-0');
                explorer.classList.remove('w-64');
                explorer.classList.remove('border-r'); // Hide border when collapsed
            } else {
                explorer.classList.remove('w-0');
                explorer.classList.add('w-64');
                explorer.classList.add('border-r'); // Show border when expanded
            }
        }

        // --- Advanced Text Operations ---

        function transformText(operation) {
            const editor = document.getElementById('editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);

            if (!selectedText) {
                showModal('No Selection', 'Please select text to apply the transformation.');
                return;
            }

            let transformedText = '';

            switch (operation) {
                case 'uppercase':
                    transformedText = selectedText.toUpperCase();
                    break;
                case 'lowercase':
                    transformedText = selectedText.toLowerCase();
                    break;
                case 'capitalize':
                    transformedText = selectedText.replace(/\b\w/g, l => l.toUpperCase());
                    break;
                case 'reverse':
                    transformedText = selectedText.split('').reverse().join('');
                    break;
                default:
                    return;
            }

            const beforeSelection = editor.value.substring(0, start);
            const afterSelection = editor.value.substring(end);

            editor.value = beforeSelection + transformedText + afterSelection;
            editor.setSelectionRange(start, start + transformedText.length);

            handleEditorChange();
        }

        // Text statistics
        function getTextStatistics() {
            const editor = document.getElementById('editor');
            const content = editor.value;

            const stats = {
                characters: content.length,
                charactersNoSpaces: content.replace(/\s/g, '').length,
                words: content.trim() === '' ? 0 : content.trim().split(/\s+/).length,
                lines: content.split('\n').length,
                paragraphs: content.split(/\n\s*\n/).filter(p => p.trim()).length
            };

            const message = `
                <p><strong>Text Statistics:</strong></p>
                <ul class="list-disc list-inside mt-2 text-sm">
                    <li>Characters: ${stats.characters}</li>
                    <li>Characters (no spaces): ${stats.charactersNoSpaces}</li>
                    <li>Words: ${stats.words}</li>
                    <li>Lines: ${stats.lines}</li>
                    <li>Paragraphs: ${stats.paragraphs}</li>
                </ul>
            `;

            showModal('Text Statistics', message);
        }

        // Duplicate line
        function duplicateLine() {
            const editor = document.getElementById('editor');
            const lines = editor.value.split('\n');
            const cursorPos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            const currentLineNumber = textBeforeCursor.split('\n').length - 1;
            const currentLine = lines[currentLineNumber];

            if (!currentLine) return; // Nothing to duplicate if line is empty or non-existent

            lines.splice(currentLineNumber + 1, 0, currentLine);
            editor.value = lines.join('\n');

            // Move cursor to the start of the duplicated line
            const newCursorPos = cursorPos + currentLine.length + 1;
            editor.setSelectionRange(newCursorPos, newCursorPos);

            handleEditorChange();
        }

        // Delete line
        function deleteLine() {
            const editor = document.getElementById('editor');
            const lines = editor.value.split('\n');
            const cursorPos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            const currentLineNumber = textBeforeCursor.split('\n').length - 1;

            if (lines.length > 1) {
                lines.splice(currentLineNumber, 1);
                editor.value = lines.join('\n');

                // Adjust cursor position to the start of the new current line
                const linesBefore = lines.slice(0, currentLineNumber).join('\n');
                const newCursorPos = linesBefore.length + (linesBefore.length > 0 ? 1 : 0); // +1 for the newline char
                editor.setSelectionRange(newCursorPos, newCursorPos);

                handleEditorChange();
            } else if (lines.length === 1 && lines[0].trim() !== '') {
                // If only one non-empty line, clear it
                editor.value = '';
                editor.selectionStart = editor.selectionEnd = 0;
                handleEditorChange();
            } else {
                showModal('Delete Line', 'Nothing to delete.');
            }
        }

        // Sort lines
        function sortLines(ascending = true) {
            const editor = document.getElementById('editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;

            let textToSort;
            let beforeText = '';
            let afterText = '';

            if (start === end) {
                // No selection, sort entire document
                textToSort = editor.value;
            } else {
                // Sort selected text
                beforeText = editor.value.substring(0, start);
                textToSort = editor.value.substring(start, end);
                afterText = editor.value.substring(end);
            }

            const lines = textToSort.split('\n');
            lines.sort((a, b) => {
                if (ascending) {
                    return a.localeCompare(b);
                } else {
                    return b.localeCompare(a);
                }
            });

            const sortedText = lines.join('\n');
            editor.value = beforeText + sortedText + afterText;

            if (start !== end) {
                editor.setSelectionRange(start, start + sortedText.length);
            }

            handleEditorChange();
        }

        // --- Syntax Highlighting ---
        function highlightCode() {
            const editor = document.getElementById('editor');
            const highlightedContent = document.getElementById('highlightedContent').querySelector('code');
            const currentFile = files[currentFileIndex];

            if (!currentFile) return;

            const language = currentFile.language;
            const text = editor.value;

            // Load language grammar if not already loaded by autoloader
            if (!Prism.languages[language]) {
                Prism.plugins.autoloader.loadLanguages([language], () => {
                    highlightedContent.innerHTML = Prism.highlight(text, Prism.languages[language], language);
                });
            } else {
                highlightedContent.innerHTML = Prism.highlight(text, Prism.languages[language], language);
            }
        }

        // --- Custom Modal System ---
        let resolveModalPromise;

        function showModal(title, message) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalInput').classList.add('hidden');
            document.getElementById('modalConfirmBtn').classList.remove('hidden');
            document.getElementById('modalCancelBtn').classList.add('hidden');

            modal.classList.remove('hidden');

            return new Promise(resolve => {
                resolveModalPromise = resolve;
                document.getElementById('modalConfirmBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolveModalPromise(true);
                };
            });
        }

        function showConfirmModal(title, message) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalInput').classList.add('hidden');
            document.getElementById('modalConfirmBtn').classList.remove('hidden');
            document.getElementById('modalCancelBtn').classList.remove('hidden');

            modal.classList.remove('hidden');

            return new Promise(resolve => {
                resolveModalPromise = resolve;
                document.getElementById('modalConfirmBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolveModalPromise(true);
                };
                document.getElementById('modalCancelBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolveModalPromise(false);
                };
            });
        }

        function showPromptModal(title, message, defaultValue = '') {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalMessage').innerHTML = message;
            const input = document.getElementById('modalInput');
            input.value = defaultValue;
            input.classList.remove('hidden');
            document.getElementById('modalConfirmBtn').classList.remove('hidden');
            document.getElementById('modalCancelBtn').classList.remove('hidden');

            modal.classList.remove('hidden');
            input.focus();

            return new Promise(resolve => {
                resolveModalPromise = resolve;
                document.getElementById('modalConfirmBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolveModalPromise(input.value);
                };
                document.getElementById('modalCancelBtn').onclick = () => {
                    modal.classList.add('hidden');
                    resolveModalPromise(null); // Resolve with null if cancelled
                };
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('modalConfirmBtn').click();
                    }
                };
            });
        }

        // --- Context Menus ---
        let currentContextMenu = null;

        function showContextMenu(e, items) {
            e.preventDefault();
            hideContextMenu(); // Hide any existing menu

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;

            items.forEach(item => {
                if (item === 'separator') {
                    const separator = document.createElement('div');
                    separator.className = 'context-menu-separator';
                    menu.appendChild(separator);
                } else {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'context-menu-item';
                    menuItem.textContent = item.label;
                    menuItem.onclick = () => {
                        item.action();
                        hideContextMenu();
                    };
                    menu.appendChild(menuItem);
                }
            });

            document.body.appendChild(menu);
            currentContextMenu = menu;

            // Close menu when clicking outside
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('contextmenu', hideContextMenu);
        }

        function hideContextMenu() {
            if (currentContextMenu) {
                document.body.removeChild(currentContextMenu);
                currentContextMenu = null;
                document.removeEventListener('click', hideContextMenu);
                document.removeEventListener('contextmenu', hideContextMenu);
            }
        }

        // Editor context menu
        function showEditorContextMenu(e) {
            const items = [
                { label: 'Cut', action: () => document.execCommand('cut') },
                { label: 'Copy', action: () => document.execCommand('copy') },
                { label: 'Paste', action: () => document.execCommand('paste') },
                'separator',
                { label: 'Undo', action: undo },
                { label: 'Redo', action: redo },
                'separator',
                { label: 'Select All', action: selectAll },
                { label: 'Find...', action: showFindDialog },
                { label: 'Replace...', action: showReplaceDialog }
            ];
            showContextMenu(e, items);
        }

        // File explorer item context menu
        function showFileContextMenu(e, fileIndex) {
            e.preventDefault(); // Prevent default browser context menu
            hideContextMenu(); // Hide any other open context menus

            const file = files[fileIndex];
            if (!file) return;

            const items = [
                { label: `Open "${file.name}"`, action: () => switchToFile(fileIndex) },
                { label: 'Rename', action: () => renameFile(fileIndex) },
                { label: 'Delete', action: () => deleteFile(fileIndex) },
                'separator',
                { label: 'Save to Cloud', action: () => saveFileToCloud(fileIndex) },
                { label: 'Delete from Cloud', action: () => deleteFileFromCloud(fileIndex) }
            ];
            showContextMenu(e, items);
        }

        // File operations from context menu
        function renameFile(index) {
            const file = files[index];
            showPromptModal('Rename File', `Rename "${file.name}" to:`, file.name)
                .then(newName => {
                    if (newName && newName.trim() !== '' && newName !== file.name) {
                        file.name = newName;
                        file.language = getLanguageFromExtension(newName);
                        file.modified = true; // Renaming counts as modification
                        updateTabs();
                        updateFileList();
                        updateStatusBar();
                        saveToLocalStorage();
                        showModal('Renamed', `File renamed to "${newName}".`);
                    } else if (newName !== null && newName.trim() === '') {
                        showModal('Invalid Name', 'File name cannot be empty.');
                    }
                });
        }

        async function deleteFile(index) {
            const file = files[index];
            if (!file) return;

            const confirmed = await showConfirmModal('Delete File', `Are you sure you want to delete "${file.name}"? This action cannot be undone locally.`);
            if (confirmed) {
                _closeFileInternal(index); // This handles local deletion and switching
                showModal('Deleted', `File "${file.name}" deleted locally.`);
            }
        }

        async function saveFileToCloud(index) {
            if (!isAuthReady || !userId) {
                showModal('Authentication Required', 'Please wait for authentication to complete before saving to cloud.');
                return;
            }
            const file = files[index];
            if (!file) return;

            try {
                const fileDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/files`, file.id);
                await setDoc(fileDocRef, {
                    name: file.name,
                    content: file.content,
                    language: file.language,
                    lastModified: new Date().toISOString()
                });
                file.modified = false;
                updateTabs();
                updateStatusBar();
                showModal('Cloud Save', `File "${file.name}" saved to cloud.`);
                await window.saveAllToCloud(); // Update metadata after single file save
            } catch (error) {
                console.error("Error saving file to Firestore:", error);
                showModal('Error', `Failed to save "${file.name}" to cloud: ${error.message}`);
            }
        }

        async function deleteFileFromCloud(index) {
            if (!isAuthReady || !userId) {
                showModal('Authentication Required', 'Please wait for authentication to complete before deleting from cloud.');
                return;
            }
            const file = files[index];
            if (!file) return;

            const confirmed = await showConfirmModal('Delete from Cloud', `Are you sure you want to delete "${file.name}" from cloud storage? This will not delete the local file.`);
            if (confirmed) {
                try {
                    const fileDocRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/files`, file.id);
                    await deleteDoc(fileDocRef);
                    showModal('Cloud Delete', `File "${file.name}" deleted from cloud storage.`);
                    await window.saveAllToCloud(); // Update metadata after deletion
                } catch (error) {
                    console.error("Error deleting file from Firestore:", error);
                    showModal('Error', `Failed to delete "${file.name}" from cloud: ${error.message}`);
                }
            }
        }

        // Add editor context menu listener
        document.getElementById('editor').addEventListener('contextmenu', showEditorContextMenu);


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            init();
            // Initial highlight after content is loaded
            highlightCode();

            console.log('Notepad++ Web Clone - Keyboard Shortcuts:');
            console.log('Ctrl+N: New File');
            console.log('Ctrl+O: Open File');
            console.log('Ctrl+S: Save File');
            console.log('Ctrl+Shift+S: Save As');
            console.log('Ctrl+F: Find');
            console.log('Ctrl+H: Find & Replace');
            console.log('Ctrl+Z: Undo');
            console.log('Ctrl+Y: Redo');
            console.log('Ctrl+A: Select All');
            console.log('Ctrl+Shift+D: Duplicate Line');
            console.log('Ctrl+Shift+L: Delete Line');
            console.log('Ctrl+Shift+U: Transform to Uppercase');
            console.log('Ctrl+Shift+Alt+I: Text Statistics');
            console.log('Tab: Indent');
            console.log('Shift+Tab: Unindent');
        });
    </script>
</body>
</html>
